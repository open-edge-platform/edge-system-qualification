# Copyright (C) 2025 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

kpi:
  streams_max:
    name: "Maximum Streams"
    type: "numeric"
    validation:
      operator: "gte"
      reference: 2
      enabled: false
    unit: "streams"
    severity: "normal"
    description: "Maximum number of concurrent video streams"
    default_value: 0.0

  streams_max_cpu:
    name: "Maximum Streams CPU"
    type: "numeric"
    validation:
      operator: "gte"
      reference: 2
      enabled: false
    unit: "streams"
    severity: "normal"
    description: "Maximum number of concurrent video streams on CPU"
    default_value: 0.0

  streams_max_igpu:
    name: "Maximum Streams iGPU"
    type: "numeric"
    validation:
      operator: "gte"
      reference: 2
      enabled: false
    unit: "streams"
    severity: "normal"
    description: "Maximum number of concurrent video streams on iGPU"
    default_value: 0.0

  streams_max_dgpu:
    name: "Maximum Streams dGPU"
    type: "numeric"
    validation:
      operator: "gte"
      reference: 2
      enabled: false
    unit: "streams"
    severity: "normal"
    description: "Maximum number of concurrent video streams on dGPU"
    default_value: 0.0

  streams_max_npu:
    name: "Maximum Streams NPU"
    type: "numeric"
    validation:
      operator: "gte"
      reference: 2
      enabled: false
    unit: "streams"
    severity: "normal"
    description: "Maximum number of concurrent video streams on NPU"
    default_value: 0.0

tests:
  test_dlstreamer:
    params:
      - display_name: "DL Streamer - Default"
        assets:
          # Video assets
          # Video asset with H.264 codec, resolution downscale, and duration trim
          - id: "video_1192116"
            type: "video"
            name: "1192116-hd_1920_1080_15fps_30s.mp4"
            url: "https://videos.pexels.com/video-files/1192116/1192116-hd_1920_1080_30fps.mp4"
            sha256: "65d836330fda9cfe6aa7a6bb4b2a81df4897325133da096b275e40b359e2d4ea"
            fps: 15         # Convert from 30 FPS to 15 FPS
            duration: 30    # Trim to 30 seconds
            # codec: "h264" is default, no need to specify
          # Video asset with H.265 codec conversion from 4K 60fps source to 1080p 30fps
          # Output: Raw H.265 elementary stream with .h265 extension (no container)
          - id: "video_18856748_h265"
            type: "video"
            name: "18856748-fhd_1920_1080_30fps.h265"
            url: "https://videos.pexels.com/video-files/18856748/18856748-uhd_3840_2160_60fps.mp4"
            sha256: "2bcbd55f8ab8f34cbce33af0a7f372c2d4648b4386249728ba4c6cd51e8d7985"
            width: 1920   # Convert from 3840 (4K) to 1920 (1080p)
            height: 1080  # Convert from 2160 (4K) to 1080 (1080p)
            fps: 30       # Convert from 60 FPS to 30 FPS
            codec: "h265" # Convert to H.265/HEVC codec (default is H.264)
          - id: "video_warehouse"
            type: "video"
            name: "warehouse.avi"
            url: "https://github.com/open-edge-platform/edge-ai-resources/raw/c13b8dbf23d514c2667d39b66615bd1400cb889d/videos/warehouse.avi"
            sha256: "cec6414d5197c3974896bc8f5b15c4a6a683b654f6ec01e9706fcee1b034d748"
          # Model assets
          - id: "yolo11n"
            type: "model"
            source: "ultralytics"
            precision: "fp16"  # supported precision to be exported: fp32, fp16, int8
            format: "pt"
          - id: "yoloxtiny_pallet_defect_detection"
            type: "model"
            source: "zip"
            url: "https://github.com/open-edge-platform/edge-ai-resources/raw/c13b8dbf23d514c2667d39b66615bd1400cb889d/models/pallet_defect_detection.zip"
            sha256: "05284de2f3a48c646cc341d0dc93e936e2afd0f37b751338b9b78b6fd3bf171c"
            precision: "fp32"  # exported model precision metadata
            format: "openvino"
          - id: "efficientnet_b0"
            type: "model"
            source: "files"
            url: 
              - xml: "https://raw.githubusercontent.com/dlstreamer/pipeline-zoo-models/refs/heads/main/storage/efficientnet-b0_INT8/FP16-INT8/efficientnet-b0.xml"
              - bin: "https://raw.githubusercontent.com/dlstreamer/pipeline-zoo-models/refs/heads/main/storage/efficientnet-b0_INT8/FP16-INT8/efficientnet-b0.bin"
            sha256:
              - xml: "e9f959bb05ea1dc4d4735acc62e3d959fa2982b82e9608325157ba3598b5b999"
              - bin: "2ee5a5ad5a9a1a00d057e50af5da56e3bf09f633f66e9f77b9a1915ab862c536"
            precision: "fp16"  # exported model precision metadata
            format: "openvino"
          # File assets
          - id: "imagenet_2012.txt"
            type: "file"
            url: "https://raw.githubusercontent.com/open-edge-platform/edge-ai-libraries/main/libraries/dl-streamer/samples/labels/imagenet_2012.txt"
            sha256: "acf75ef0abe89694b19056e0796401068b459c457baa30335f240c7692857355"
            path: "./labels/imagenet_2012.txt"
        pipeline: |
          filesrc location=./videos/1192116-hd_1920_1080_15fps_30s.mp4
            ! ${DECODE_ELEMENTS}
            ! gvadetect model=./models/yolo11n/fp16/yolo11n.xml device=${DEVICE_ID} ${INFERENCE_ELEMENTS} batch-size=1
            ! queue
        pipeline_params:
          DECODE_ELEMENTS:
            cpu: "parsebin ! avdec_h264 ! 'video/x-raw'"
            gpu_integrated: "parsebin ! vah264dec ! vapostproc ! 'video/x-raw(memory:VAMemory)'"
            gpu_discrete: "parsebin ! varenderD{RENDER_DEVICE_NUM}h264dec ! {VIDEO_RAW_TYPE}"
            npu: "parsebin ! vah264dec ! 'video/x-raw(memory:VAMemory)'"
          INFERENCE_ELEMENTS:
            cpu: "pre-process-backend={PRE_PROCESS_BACKEND}"
            gpu_integrated: "pre-process-backend={PRE_PROCESS_BACKEND} model-instance-id=inst0"
            gpu_discrete: "pre-process-backend={PRE_PROCESS_BACKEND}"
            npu: "pre-process-backend={PRE_PROCESS_BACKEND}"
          PRE_PROCESS_BACKEND:
            cpu: "ie"
            gpu_integrated: "va-surface-sharing"
            gpu_discrete: "va-surface-sharing"
            npu: "va"
          VIDEO_RAW_TYPE:
            default: "'video/x-raw(memory:VAMemory)'"
            overrides:
              FULL_DEVICE_NAME:
                "Intel(R) Unsupported video type": "'video/x-raw'"
          # =============================================================================
          # SINK_ELEMENT: Configurable GStreamer Sink Elements
          # =============================================================================
          # Specifies the output sink element for the pipeline. Supports full GStreamer
          # element specification with properties and element chaining.
          #
          # Common Use Cases:
          # -----------------
          # 1. No Visualization (Default - Maximum Performance):
          #    - "fakesink sync=true"  : Real-time streaming (respects video timestamps)
          #    - "fakesink sync=false" : Maximum throughput (process as fast as possible)
          #
          # 2. Video Recording:
          #    - "filesink location=/tmp/output.mp4 sync=false"
          #    - Device-specific: "filesink location=/tmp/output_${DEVICE_ID}.mp4"
          #
          # 3. Display Output (Requires X11 Access from Container):
          #    - "autovideosink"           : Auto-select best available display
          #    - "ximagesink display=:0"   : X11 display output
          #    - "xvimagesink display=:0"  : X11 with Xv extension
          #
          # 4. Visualization with Watermark:
          #    - "gvawatermark device=CPU ! videoconvert ! autovideosink"
          #    - "gvawatermark device=CPU ! videoconvert ! ximagesink display=:0"
          #
          # 5. Advanced Chaining:
          #    - "videoconvert ! video/x-raw,format=BGRx ! autovideosink"
          #    - "fpsdisplaysink video-sink=autovideosink sync=false"
          #
          # IMPORTANT - Container Visualization Setup:
          # -------------------------------------------
          # When using display sinks (autovideosink, ximagesink, etc.) from Docker
          # containers, you MUST enable X11 access on the host before running tests:
          #
          #   xhost +local:root
          #
          # This allows the containerized application to connect to your X11 display.
          # Without this, you'll see errors like "Cannot open display" or "X11 connection refused".
          #
          # To restore X11 security after testing (optional):
          #   xhost -local:root
          #
          # Device-Specific Configuration:
          # -------------------------------
          # You can specify different sink elements per device type:
          SINK_ELEMENT:
            default: "fakesink sync=true"
            # Example configurations (uncomment and modify as needed):
            # cpu: "fakesink sync=true"
            # gpu_integrated: "filesink location=/tmp/igpu_output.mp4 sync=false"
            # gpu_discrete: "gvawatermark device=CPU ! videoconvert ! autovideosink"
            # npu: "ximagesink display=:0"
          #
          # =============================================================================
        # devices: [cpu, igpu, dgpu, npu] # options: [cpu, igpu, dgpu, npu]
        devices: [igpu] # options: [cpu, igpu, dgpu, npu]
        # Optional: Set to true to keep original videos in debug/ subfolder for debugging
        # Default: false (delete originals to optimize storage)
        keep_original_videos: false
        kpi_refs:
          - streams_max_igpu
